name: CI/CD - Build, Test & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full production mirror tests'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Fast validation jobs that run on every commit
  startup-validation:
    name: Startup Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run startup validation tests
        run: |
          echo "Running startup validation tests with Python 3.13"
          uv run pytest tests/test_startup_validation.py -v --tb=short
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          CELERY_BROKER_URL: memory://localhost/
          TESTING: true

      - name: Standalone startup test
        run: |
          echo "Running standalone startup validation"
          uv run python tests/test_startup_validation.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          CELERY_BROKER_URL: memory://localhost/
          TESTING: true

  # Schema immutability and core logic tests
  core-tests:
    name: Core Logic Tests
    runs-on: ubuntu-latest
    needs: startup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run field consistency tests
        run: |
          echo "Testing database schema immutability"
          uv run pytest tests/test_field_consistency_simple.py -v
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          TESTING: true

      - name: Run HTML processing tests
        run: |
          echo "Testing HTML sanitization and processing"
          uv run pytest tests/test_allowlist_html.py -v
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          TESTING: true

      - name: Run migration consistency tests
        run: |
          echo "Testing database migration consistency"
          uv run pytest tests/test_migration_heads.py -v
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          CELERY_BROKER_URL: memory://localhost/
          TESTING: true

      - name: Run explore page functionality tests
        run: |
          echo "Testing explore page rendering and content"
          uv run python tests/test_explore_ci_real_world.py
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          CELERY_BROKER_URL: memory://localhost/
          TESTING: true

      - name: Run connection pool thread-safety tests
        run: |
          echo "Testing database connection pool thread-safety"
          uv run pytest tests/test_connection_pool_thread_safety.py -v
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          TESTING: true

      - name: Run additional core tests
        run: |
          echo "Running additional core logic tests"
          # Collect all test files (excluding ones run separately and tests needing proper fixtures)
          TEST_FILES=$(find tests/ -name "test_*.py" \
            -not -name "test_startup_validation.py" \
            -not -name "test_field_consistency_simple.py" \
            -not -name "test_allowlist_html.py" \
            -not -name "test_migration_heads.py" \
            -not -name "test_explore_ci_real_world.py" \
            -not -name "test_api_*_subscriptions.py" \
            -not -name "test_api_*_bookmarks.py" \
            -not -name "test_api_get_*.py" \
            -not -name "test_api_instance_blocks.py" \
            -not -name "test_activitypub_util.py" \
            -not -name "test_explore_template_render.py" \
            -not -name "test_explore_page_integration.py" \
            -not -name "test_api_blueprint_registration.py" \
            -not -name "test_sql_injection_fixes.py" \
            -not -name "test_private_registration.py" \
            -not -name "test_explore_real_world.py" \
            -not -name "test_private_registration_security.py" \
            -not -name "test_private_registration_security_focused.py")

          # Run all tests in a single pytest command so failures propagate properly
          if [ -n "$TEST_FILES" ]; then
            echo "Running tests: $TEST_FILES"
            uv run pytest $TEST_FILES -v --tb=line
          else
            echo "No additional test files found"
          fi
        env:
          SERVER_NAME: test.localhost
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_URL: sqlite:///memory:test.db
          CACHE_TYPE: NullCache
          CACHE_REDIS_URL: memory://
          TESTING: true

  # Python code quality
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    needs: startup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run ruff linting
        run: |
          echo "Running ruff linting"
          uv run ruff check . --output-format=github
        continue-on-error: true

      - name: Run black formatting check
        run: |
          echo "Checking code formatting with black"
          uv run black --check --diff .
        continue-on-error: true

      - name: Run isort import sorting check
        run: |
          echo "Checking import sorting with isort"
          uv run isort --check-only --diff .
        continue-on-error: true

      - name: Run mypy type checking
        run: |
          echo "Running type checking with mypy"
          uv run mypy app/ --ignore-missing-imports --follow-imports=silent
        continue-on-error: true

  # Template linting
  template-quality:
    name: Template Quality
    runs-on: ubuntu-latest
    needs: startup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --frozen

      - name: Check djlint configuration
        run: |
          if [ -f .djlintrc ]; then
            echo "Found .djlintrc configuration file"
            cat .djlintrc
          else
            echo "No .djlintrc file found, using defaults"
          fi

      - name: Run template linting
        run: |
          echo "Running template linting with djlint"
          echo "Checking for common Jinja2 errors..."
          # First check for any len() usage which is invalid in Jinja2
          if grep -r "len(" app/templates --include="*.html" 2>/dev/null; then
            echo "ERROR: Found len() usage in templates. Use |length filter instead!"
            exit 1
          fi
          # Run djlint linting (ignore formatting, focus on real errors)
          if [ -f .djlintrc ]; then
            echo "Using .djlintrc configuration"
            uv run djlint app/templates --lint || exit_code=$?
          else
            echo "No .djlintrc found, using minimal checks"
            uv run djlint app/templates --lint --profile=jinja --ignore="H005,H006,H007,H013,H014,H016,H017,H020,H021,H023,H025,H026,H029,H030,H031,H037,J004,J018,T001,T002,T003,T027,T028,T032" || exit_code=$?
          fi
          if [ "${exit_code:-0}" -ne 0 ]; then
            echo "Template linting errors found!"
            exit 1
          fi

      - name: Template syntax validation
        run: |
          echo "Validating Jinja2 template syntax"
          cat > check_templates.py << 'EOF'
          import os
          import sys
          from jinja2 import Environment, FileSystemLoader, TemplateSyntaxError

          env = Environment(loader=FileSystemLoader('app/templates'))

          def mock_filter(*args, **kwargs):
              return ''

          env.filters['shorten'] = mock_filter
          env.filters['shorten_url'] = mock_filter
          env.filters['community_links'] = mock_filter
          env.filters['feed_links'] = mock_filter
          env.filters['person_links'] = mock_filter
          env.filters['remove_images'] = mock_filter

          errors = []
          warnings = []

          for root, dirs, files in os.walk('app/templates'):
              for file in files:
                  if file.endswith('.html'):
                      template_path = os.path.relpath(os.path.join(root, file), 'app/templates')
                      try:
                          env.get_template(template_path)
                          print(f'OK {template_path}')
                      except TemplateSyntaxError as e:
                          if "No filter named" in str(e):
                              warnings.append(f'WARN {template_path}: Custom filter - {e}')
                              print(f'WARN {template_path}: Custom filter - {e}')
                          else:
                              errors.append(f'ERROR {template_path}: {e}')
                              print(f'ERROR {template_path}: {e}')

          if errors:
              print(f'\nFound {len(errors)} template syntax errors!')
              sys.exit(1)
          else:
              print(f'\nAll templates have valid syntax!')
              if warnings:
                  print(f'{len(warnings)} warnings about custom filters (these are OK)')
          EOF
          uv run python check_templates.py

  # Docker build validation
  docker-validation:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: startup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          echo "Building Docker image for validation"
          docker build --target builder -t pyfedi:test .

      - name: Test Docker image startup
        run: |
          echo "Testing Docker image startup"
          docker run --rm \
            --entrypoint uv \
            -e PYTHONPATH=/app \
            -e SERVER_NAME=test.localhost \
            -e SECRET_KEY=test-secret-key \
            -e DATABASE_URL=sqlite:///memory:test.db \
            -e CACHE_TYPE=NullCache \
            -e CACHE_REDIS_URL=memory:// \
            -e CELERY_BROKER_URL=memory://localhost/ \
            -e TESTING=true \
            pyfedi:test \
            run python tests/test_startup_validation.py

  # Full production mirror tests (optional/conditional)
  production-mirror-tests:
    name: Production Mirror Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.run_full_tests == 'true' || github.ref == 'refs/heads/main' || github.event_name == 'pull_request' }}
    needs: [startup-validation, core-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run production mirror tests
        run: |
          echo "Running full production mirror test suite"
          chmod +x scripts/run-production-mirror-tests.sh
          ./scripts/run-production-mirror-tests.sh
        timeout-minutes: 15

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: production-mirror-logs
          path: |
            logs/
            *.log
          retention-days: 7

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: startup-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run Bandit security scan
        run: |
          echo "Running security scan with Bandit"
          uv run bandit -r app/ -f json -o bandit-report.json || true
          uv run bandit -r app/ || true
        continue-on-error: true

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [startup-validation, core-tests, python-quality, template-quality, docker-validation, security-scan]
    if: always()

    steps:
      - name: CI Summary
        run: |
          echo "## CI/CD Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.startup-validation.result }}" == "success" ]]; then
            echo "**Startup Validation**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Startup Validation**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.core-tests.result }}" == "success" ]]; then
            echo "**Core Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Core Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.python-quality.result }}" == "success" ]]; then
            echo "**Python Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Python Code Quality**: Issues found (not blocking)" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.template-quality.result }}" == "success" ]]; then
            echo "**Template Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Template Quality**: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.docker-validation.result }}" == "success" ]]; then
            echo "**Docker Build**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Docker Build**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "**Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Security Scan**: Issues found (review recommended)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Flask app initialization and blueprint registration" >> $GITHUB_STEP_SUMMARY
          echo "- Celery worker initialization and task discovery" >> $GITHUB_STEP_SUMMARY
          echo "- Database schema immutability validation" >> $GITHUB_STEP_SUMMARY
          echo "- HTML sanitization and content processing" >> $GITHUB_STEP_SUMMARY
          echo "- Jinja2 template syntax validation and linting" >> $GITHUB_STEP_SUMMARY
          echo "- Docker container startup validation" >> $GITHUB_STEP_SUMMARY
          echo "- Security scanning and code quality checks" >> $GITHUB_STEP_SUMMARY
