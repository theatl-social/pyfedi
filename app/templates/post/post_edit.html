{% if theme() != 'piefed' and file_exists('app/templates/themes/' + theme() + '/base.html') -%}
    {% extends 'themes/' + theme() + '/base.html' -%}
{% else -%}
    {% extends "base.html" -%}
{% endif -%}
{% from 'bootstrap5/form.html' import render_form, render_field %}
{% from "_macros.html" import render_username, render_communityname, render_feedname -%}

{% block extra_css %}
    <link href="{{ url_for('static', filename='js/tomselect/tom-select.css') }}" type="text/css" rel="stylesheet" />
{% endblock %}

{% block end_scripts -%}
    <script src="{{ url_for('static', filename='js/media_library.js', changed=getmtime('js/media_library.js')) }}" nonce={{ nonce }}></script>
{% endblock -%}

{% block app_content %}
<script src="/static/js/coolfieldset.js?v=3" nonce={{ nonce }}></script>
<script nonce="{{ nonce }}">
    function checkAndCopyTitle(curr_url = "", swapped = {}) {
      const retrieved = document.getElementById('retrieved_title');
      const retrieved_description = document.getElementById('retrieved_description');
      const title = document.getElementById('title');
      const body = document.getElementById('body');
      const link_url = document.getElementById('link_url');
      let skip = false;
      let swapped_title = false;
      let swapped_body = false;

      if (link_url && (link_url.value != curr_url)) {
        if (curr_url in swapped) {
          delete swapped[curr_url];
        }
        curr_url = link_url.value;
        swapped[curr_url] = false;
        retrieved.value = "";
        retrieved_description.value = "";
      } else {
        skip = true;
      }

      if (!skip || !swapped[curr_url]) {
        if (retrieved && title && retrieved.value && !title.value) {
            title.value = retrieved.value;
            swapped_title = true;
        }

        if (retrieved_description && body && retrieved_description.value && !body.value) {
            body.value = retrieved_description.value;
            swapped_body = true;
        }

        swapped[curr_url] = swapped_title || swapped_body;
      }

      setTimeout(checkAndCopyTitle, 1000, curr_url, swapped); // Check every second
    }

    let curr_url = "";
    let swapped = {};

    // Start the checking loop
    console.log("Starting loop...");
    checkAndCopyTitle(curr_url, swapped);

    function showHideLocationDivs(element) {
        const onlineLocation = document.getElementById('online_location');
        const irlLocation = document.getElementById('irl_location');

        if (element.checked) {
            onlineLocation.style.display = "block";
            irlLocation.style.display = "none";
        } else {
            onlineLocation.style.display = "none";
            irlLocation.style.display = "block";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const online = document.getElementById("online");
        if(online) {
            online.addEventListener('change', function () {
                showHideLocationDivs(online);
            });

            showHideLocationDivs(online);
        }

        // Initialize Media Library
        const mediaLibrary = new MediaLibrary({
            dialogId: 'insertImageDialog',
            dialogCloseId: 'insert_image_dialog_close',
            triggerLinkId: 'insertImage',
            loadContainerId: 'loadImagesHere',
            targetTextareaId: 'body',
            uploadInputId: 'imageUploadInput',
            uploadButtonId: 'imageUploadButton',
            uploadStatusId: 'uploadStatus',
            translations: {
                loading: "{{ _("Loading...") }}",
                noImages: "{{ _("No images found.") }}",
                errorLoading: "{{ _("Error loading images.") }}",
                insert: "{{ _("Insert") }}",
                more: "{{ _("More") }}",
                delete: "{{ _("Delete") }}",
                confirmDelete: "{{ _("Are you sure you want to delete this image?") }}",
                deleteError: "{{ _("Failed to delete image. Please try again.") }}",
                selectFile: "{{ _("Please select a file.") }}",
                selectImage: "{{ _("Please select an image file.") }}",
                uploading: "{{ _("Uploading...") }}",
                uploadSuccess: "{{ _("Upload successful!") }}",
                uploadError: "{{ _("Upload failed. Please try again.") }}",
                pasteUploadError: "{{ _("Failed to upload pasted image. Please try again.") }}"
            }
        });

        {% if markdown_editor %}
        // Override DownArea image button to use media library
        mediaLibrary.overrideDownAreaImageButton('#body', 1500);
        {% endif %}
    });
</script>
<div class="row">
    <main class="col-12 col-lg-8 position-relative main_pane">
        {% block title %}<h1>{{ _('Edit post') }}</h1>{% endblock %}
        <form method="post" enctype="multipart/form-data" role="form">
            {{ form.csrf_token() }}
            {% block post_type %}{% endblock %}
            {% if post_type == POST_TYPE_LINK %}
                {{ render_field(form.link_url) }}
                {{ render_field(form.image_alt_text) }}
                <div id="urlUsed"></div>
                <input type="hidden" id="retrieved_title" value="">
                <input type="hidden" id="retrieved_description" value="">
            {% endif -%}
            {{ render_field(form.title) }}
            {% if post_type == POST_TYPE_EVENT %}
                {{ render_field(form.start_datetime) }}
                {{ render_field(form.end_datetime) }}
                {{ render_field(form.event_timezone) }}
            {% endif %}
            {% if post_type == POST_TYPE_IMAGE or post_type == POST_TYPE_EVENT %}
                {% if post.image_id -%}
                    <div class="post_image">
                        {% if low_bandwidth -%}
                            <a href="{{ post.image.view_url(resize=True) }}" rel="nofollow ugc"><img src="{{ post.image.medium_url() }}"
                                alt="{{ post.image.alt_text if post.image.alt_text else post.title }}" fetchpriority="high" referrerpolicy="same-origin"
                                width="{{ post.image.width }}" height="{{ post.image.height }}" /></a>
                        {% else -%}
                            <a href="{{ post.image.view_url() }}" rel="nofollow ugc">
                                <img id="image_preview_edit" src="{{ post.image.view_url(resize=True) }}" lowsrc="{{ post.image.medium_url() }}"
                                    sizes="(max-width: 512px) 100vw, 854px" srcset="{{ post.image.medium_url() }} 512w, {{ post.image.view_url(resize=True) }} 1024w"
                                    alt="{{ post.image.alt_text if post.image.alt_text else post.title }}"
                                    fetchpriority="high" referrerpolicy="same-origin" >
                            </a>
                        {% endif -%}
                    </div>                
                {% endif %}
                {{ render_field(form.image_file) }}
                <img id="image_preview" style="" alt="Image preview">
                {% if post_type == POST_TYPE_IMAGE -%}
                    {{ render_field(form.image_alt_text) }}
                    <small class="field_hint">{{ _('Describe the image, to help visually impaired people.') }}</small>
                {% endif %}
            {% elif post_type == POST_TYPE_VIDEO %}
                {{ render_field(form.video_url) }}
                <p class="small field_hint">{{ _('Provide a URL ending with .mp4 or .webm.') }}</p>
            {% endif %}
            {{ render_field(form.body) }}

            {% if not low_bandwidth -%}
                <div class="row mb-3">
                    <div class="col-6">
                        <a href="#" class="btn btn-outline-secondary" hx-post="{{ url_for('post.preview') }}" hx-target="#preview">{{ _('Preview') }}</a>
                        <a href="#" class="btn btn-outline-secondary {{ 'd-none' if markdown_editor }}" id="insertImage">{{ _('Insert image') }}</a>
                    </div>
                    <div class="col-6 text-right">
                        {% if markdown_editor %}
                            <script nonce="{{ nonce }}">
                                window.addEventListener("load", function () {
                                    var downarea = new DownArea({
                                        elem: document.querySelector('#body'),
                                        resize: DownArea.RESIZE_VERTICAL,
                                        hide: ['heading', 'bold-italic'],
                                        value: document.getElementById("body").value
                                    });
                                    setupAutoResize('body');
                                });
                            </script>
                        {% else %}
                            <a href="#" aria-hidden="true" class="markdown_editor_enabler create_post_markdown_editor_enabler" data-id="body">{{ _('Enable markdown editor') }}</a>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="preview"></div>
                    </div>
                </div>
            {% endif -%}

            {{ render_field(form.language_id) }}

            {% if post_type == POST_TYPE_POLL %}
                <fieldset id="pollChoicesFieldset">
                    <legend>{{ _('Poll choices') }}</legend>
                    <div class="form-group">
                        {{ form.choice_1(class_="form-control", **{"placeholder": "First choice"}) }}
                    </div>
                    <div class="form-group">
                        {{ form.choice_2(class_="form-control", **{"placeholder": "Second choice"}) }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_3.data == none }}">
                        {{ form.choice_3(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_4.data == none }}">
                        {{ form.choice_4(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_5.data == none }}">
                        {{ form.choice_5(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_6.data == none }}">
                        {{ form.choice_6(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_7.data == none }}">
                        {{ form.choice_7(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_8.data == none }}">
                        {{ form.choice_8(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_9.data == none }}">
                        {{ form.choice_9(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_10(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_11(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_12(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_13(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_14(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_15(class_="form-control") }}
                    </div>
                    <button id="addPollChoice" type="button" class="btn btn-primary">{{ _('Add choice') }}</button>
                </fieldset>
                {{ render_field(form.mode) }}
                {% if form.finish_in %}{{ render_field(form.finish_in) }}{% endif %}
                {{ render_field(form.local_only) }}
            {% endif %}

            {% if post_type == POST_TYPE_EVENT %}
                {{ render_field(form.max_attendees) }}
                {{ render_field(form.join_mode) }}
                {{ render_field(form.online) }}
                <div id="online_location" style="{% if event_online is false %}display: none;{% endif %}">
                    {{ render_field(form.online_link) }}
                </div>
                <div id="irl_location" style="{% if event_online %}display: none;{% endif %}">
                    {{ render_field(form.irl_address) }}
                    {{ render_field(form.irl_city) }}
                    {{ render_field(form.irl_country) }}
                </div>
            {% endif %}

            <div id="communityFlair">
                {% if form.flair %}{{ render_field(form.flair) }}{% endif %}
            </div>
            {{ render_field(form.tags) }}
            <small class="field_hint">{{ _('Separate each tag with a comma.') }}</small>

            <fieldset id="post_more_options" class="mt-4 mb-4 coolfieldset {{ 'collapsed' if request.cookies.get('fieldset_post_more_options_state', 'collapsed') == 'collapsed' }}">
                <legend class="w-auto">{{ _('More options') }}</legend>
                {{ render_field(form.notify_author) }}
                {{ render_field(form.sticky) }}
                {{ render_field(form.nsfw) }}
                {{ render_field(form.nsfl) }}
                {{ render_field(form.ai_generated) }}
                {{ render_field(form.scheduled_for) }}
                {{ render_field(form.timezone) }}
                {{ render_field(form.repeat) }}

                <div class="accordion accordion-flush" id="accordionFlushExample">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
        {{ _('Hey, did you know? Scheduled posts have a templating system for titles.') }}
      </button>
    </h2>
    <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body">
            <p>{{ _('Tags available') }}:<code>{% raw %}{% week %}, {% day %}, {% month %}, {% year %}{% endraw %}</code></p>
            <p>{{ _('Example') }}: <code>{% raw %}[Topic week {% week %}] Today's date {% year %}-{% month %}-{% day %}{% endraw %}</code></p>
            <p>{{ _('...will generate') }}</p>
            <p>[Topic week 27] Today's date 2025-06-25</p>
        </div>
    </div>
  </div>
</div>
            </fieldset>

            {{ render_field(form.submit) }}
        </form>
        <p>&nbsp;</p>
        <hr>
        <p>{{ _('Drag this link to your bookmarks bar to create a quick way to share what you find') }}:</p>
        <p>
        <a href="javascript:(function(){
          var url = encodeURIComponent(window.location.href);
          var title = encodeURIComponent(document.title);
          window.open('https://{{ instance_domain }}/share?url=' + url + '&title=' + title, '_blank');
        })();"
           title="Drag this to your bookmarks bar"
           style="cursor: grab; text-decoration: underline;">{{ _('Share on PieFed') }}</a></p>
    <script src="/static/js/tomselect/tom-select.complete.min.js" nonce={{ nonce }}></script>
    <script nonce="{{ nonce }}">
      document.addEventListener("DOMContentLoaded", () => {
        new TomSelect(".tom-select", {
          plugins: ['dropdown_input'],
          create: false,
          maxOptions: 2000,
       })
    });
    </script>
    </main>

    {% include "_side_pane.html" %}

</div>
{% include "_insert_image_dialog.html" %}
{% endblock %}
