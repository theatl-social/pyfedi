{% if theme() != 'piefed' and file_exists('app/templates/themes/' + theme() + '/base.html') -%}
    {% extends 'themes/' + theme() + '/base.html' -%}
{% else -%}
    {% extends "base.html" -%}
{% endif -%}
{% from 'bootstrap5/form.html' import render_form, render_field %}
{% from "_macros.html" import render_username, render_communityname, render_feedname -%}

{% block extra_css %}
    <link href="{{ url_for('static', filename='js/tomselect/tom-select.css') }}" type="text/css" rel="stylesheet" />
{% endblock %}

{% block app_content %}
<script src="/static/js/coolfieldset.js?v=3"></script>
<script nonce="{{ nonce }}">
    function checkAndCopyTitle(curr_url = "", swapped = {}) {
      const retrieved = document.getElementById('retrieved_title');
      const retrieved_description = document.getElementById('retrieved_description');
      const title = document.getElementById('title');
      const body = document.getElementById('body');
      const link_url = document.getElementById('link_url');
      let skip = false;
      let swapped_title = false;
      let swapped_body = false;

      if (link_url && (link_url.value != curr_url)) {
        if (curr_url in swapped) {
          delete swapped[curr_url];
        }
        curr_url = link_url.value;
        swapped[curr_url] = false;
        retrieved.value = "";
        retrieved_description.value = "";
      } else {
        skip = true;
      }

      if (!skip || !swapped[curr_url]) {
        if (retrieved && title && retrieved.value && !title.value) {
            title.value = retrieved.value;
            swapped_title = true;
        }

        if (retrieved_description && body && retrieved_description.value && !body.value) {
            body.value = retrieved_description.value;
            swapped_body = true;
        }

        swapped[curr_url] = swapped_title || swapped_body;
      }

      setTimeout(checkAndCopyTitle, 1000, curr_url, swapped); // Check every second
    }

    let curr_url = "";
    let swapped = {};

    // Start the checking loop
    console.log("Starting loop...");
    checkAndCopyTitle(curr_url, swapped);

    function showHideLocationDivs(element) {
        const onlineLocation = document.getElementById('online_location');
        const irlLocation = document.getElementById('irl_location');

        if (element.checked) {
            onlineLocation.style.display = "block";
            irlLocation.style.display = "none";
        } else {
            onlineLocation.style.display = "none";
            irlLocation.style.display = "block";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const online = document.getElementById("online");
        if(online) {
            online.addEventListener('change', function () {
                showHideLocationDivs(online);
            });

            showHideLocationDivs(online);
        }

        // set up event handlers for insertImageDialog:
        const insertImageLink = document.getElementById('insertImage');
        const insertImageDialog = document.getElementById('insertImageDialog');
        const dialogClose = document.getElementById('insert_image_dialog_close');
        const loadImagesContainer = document.getElementById('loadImagesHere');
        const bodyTextarea = document.getElementById('body');

        // Function to load and render image thumbnails
        function loadImageThumbnails() {
            loadImagesContainer.innerHTML = '<p class="text-center">{{ _("Loading...") }}</p>';

            fetch('/api/alpha/user/media?limit=50')
                .then(response => response.json())
                .then(data => {
                    loadImagesContainer.innerHTML = '';

                    if (data.media && data.media.length > 0) {
                        const grid = document.createElement('div');
                        grid.className = 'd-grid gap-2';
                        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';

                        data.media.forEach(function(image) {
                            const imgWrapper = document.createElement('div');
                            imgWrapper.style.position = 'relative';
                            imgWrapper.style.cursor = 'pointer';
                            imgWrapper.style.aspectRatio = '1';
                            imgWrapper.style.overflow = 'hidden';
                            imgWrapper.style.borderRadius = '8px';
                            imgWrapper.style.border = '2px solid transparent';
                            imgWrapper.style.transition = 'border-color 0.2s';

                            const img = document.createElement('img');
                            img.src = image.url;
                            img.alt = image.name;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';

                            // Retry loading if image fails (for R2 propagation delays)
                            let retryCount = 0;
                            img.onerror = function() {
                                if (retryCount < 3) {
                                    retryCount++;
                                    setTimeout(function() {
                                        img.src = image.url + '?retry=' + retryCount;
                                    }, retryCount * 500); // 500ms, 1s, 1.5s
                                }
                            };

                            imgWrapper.appendChild(img);

                            // Create overlay with action buttons
                            const overlay = document.createElement('div');
                            overlay.style.position = 'absolute';
                            overlay.style.top = '0';
                            overlay.style.left = '0';
                            overlay.style.width = '100%';
                            overlay.style.height = '100%';
                            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                            overlay.style.display = 'none';
                            overlay.style.flexDirection = 'column';
                            overlay.style.alignItems = 'center';
                            overlay.style.justifyContent = 'center';
                            overlay.style.gap = '10px';
                            overlay.style.padding = '10px';

                            // Insert button
                            const insertBtn = document.createElement('button');
                            insertBtn.className = 'btn btn-primary btn-sm';
                            insertBtn.textContent = '{{ _("Insert") }}';
                            insertBtn.style.width = '80%';
                            insertBtn.onclick = function(e) {
                                e.stopPropagation();
                                const markdown = '\n![' + image.name + '](' + image.url + ')\n';
                                const cursorPos = bodyTextarea.selectionStart;
                                const textBefore = bodyTextarea.value.substring(0, cursorPos);
                                const textAfter = bodyTextarea.value.substring(cursorPos);

                                bodyTextarea.value = textBefore + markdown + textAfter;
                                bodyTextarea.focus();
                                bodyTextarea.setSelectionRange(cursorPos + markdown.length, cursorPos + markdown.length);

                                insertImageDialog.close();
                            };

                            // More button with dropdown
                            const moreContainer = document.createElement('div');
                            moreContainer.className = 'dropdown';
                            moreContainer.style.width = '80%';

                            const moreBtn = document.createElement('button');
                            moreBtn.className = 'btn btn-secondary btn-sm dropdown-toggle w-100';
                            moreBtn.textContent = '{{ _("More") }}';
                            moreBtn.setAttribute('data-bs-toggle', 'dropdown');
                            moreBtn.onclick = function(e) {
                                e.stopPropagation();
                            };

                            const dropdownMenu = document.createElement('ul');
                            dropdownMenu.className = 'dropdown-menu';

                            // // Compress option
                            // const compressItem = document.createElement('li');
                            // const compressLink = document.createElement('a');
                            // compressLink.className = 'dropdown-item';
                            // compressLink.href = '#';
                            // compressLink.textContent = '{{ _("Compress") }}';
                            // compressLink.onclick = function(e) {
                            //     e.preventDefault();
                            //     e.stopPropagation();
                            //     console.log('Compress:', image.url);
                            //     // TODO: Implement compress API call
                            // };
                            // compressItem.appendChild(compressLink);

                            // // Rename option
                            // const renameItem = document.createElement('li');
                            // const renameLink = document.createElement('a');
                            // renameLink.className = 'dropdown-item';
                            // renameLink.href = '#';
                            // renameLink.textContent = '{{ _("Rename") }}';
                            // renameLink.onclick = function(e) {
                            //     e.preventDefault();
                            //     e.stopPropagation();
                            //     console.log('Rename:', image.name);
                            //     // TODO: Implement rename API call
                            // };
                            // renameItem.appendChild(renameLink);

                            // Delete option
                            const deleteItem = document.createElement('li');
                            const deleteLink = document.createElement('a');
                            deleteLink.className = 'dropdown-item text-danger';
                            deleteLink.href = '#';
                            deleteLink.textContent = '{{ _("Delete") }}';
                            deleteLink.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();

                                fetch('/api/alpha/image/delete', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ file: image.url })
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Delete failed');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    // Reload the image grid to show the updated list
                                    loadImageThumbnails();
                                })
                                .catch(error => {
                                    console.error('Delete error:', error);
                                    alert('{{ _("Failed to delete image. Please try again.") }}');
                                });
                            };
                            deleteItem.appendChild(deleteLink);

                            // dropdownMenu.appendChild(compressItem);
                            // dropdownMenu.appendChild(renameItem);
                            dropdownMenu.appendChild(deleteItem);

                            moreContainer.appendChild(moreBtn);
                            moreContainer.appendChild(dropdownMenu);

                            overlay.appendChild(insertBtn);
                            overlay.appendChild(moreContainer);
                            imgWrapper.appendChild(overlay);

                            // Show overlay on click
                            imgWrapper.addEventListener('click', function(e) {
                                // Hide all other overlays
                                document.querySelectorAll('#loadImagesHere .d-grid > div > div[style*="position: absolute"]').forEach(function(el) {
                                    el.style.display = 'none';
                                });
                                // Show this overlay
                                overlay.style.display = 'flex';
                            });

                            // Hover effect
                            imgWrapper.addEventListener('mouseenter', function() {
                                if (overlay.style.display !== 'flex') {
                                    imgWrapper.style.borderColor = '#0d6efd';
                                }
                            });
                            imgWrapper.addEventListener('mouseleave', function() {
                                imgWrapper.style.borderColor = 'transparent';
                            });

                            grid.appendChild(imgWrapper);
                        });

                        loadImagesContainer.appendChild(grid);
                    } else {
                        loadImagesContainer.innerHTML = '<p class="text-center text-muted">{{ _("No images found.") }}</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading media:', error);
                    loadImagesContainer.innerHTML = '<p class="text-center text-danger">{{ _("Error loading images.") }}</p>';
                });
        }

        // attach click handler to insertImage link which shows the dialog
        if (insertImageLink && insertImageDialog) {
            insertImageLink.addEventListener('click', function(e) {
                e.preventDefault();

                // Load images from API if not already loaded
                if (loadImagesContainer.children.length === 0) {
                    loadImageThumbnails();
                }

                insertImageDialog.showModal();
            });

            // Close button handler
            dialogClose.addEventListener('click', function() {
                insertImageDialog.close();
            });

            // Close on backdrop click
            insertImageDialog.addEventListener('click', function(e) {
                const rect = insertImageDialog.getBoundingClientRect();
                const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
                                   rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
                if (!isInDialog) {
                    insertImageDialog.close();
                }
            });

            // Upload functionality
            const imageUploadInput = document.getElementById('imageUploadInput');
            const imageUploadButton = document.getElementById('imageUploadButton');
            const uploadStatus = document.getElementById('uploadStatus');

            imageUploadButton.addEventListener('click', function() {
                const file = imageUploadInput.files[0];
                if (!file) {
                    uploadStatus.innerHTML = '<p class="text-warning small">{{ _("Please select a file.") }}</p>';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    uploadStatus.innerHTML = '<p class="text-danger small">{{ _("Please select an image file.") }}</p>';
                    return;
                }

                // Show uploading status
                uploadStatus.innerHTML = '<p class="text-info small">{{ _("Uploading...") }}</p>';
                imageUploadButton.disabled = true;

                // Create FormData and upload
                const formData = new FormData();
                formData.append('file', file);

                fetch('/api/alpha/upload/image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    return response.json();
                })
                .then(data => {
                    uploadStatus.innerHTML = '<p class="text-success small">{{ _("Upload successful!") }}</p>';
                    imageUploadInput.value = '';
                    imageUploadButton.disabled = false;

                    // Reload the image grid after a short delay to allow object storage to propagate
                    setTimeout(function() {
                        loadImageThumbnails();
                    }, 1000);

                    // Clear upload status after 3 seconds
                    setTimeout(function() {
                        uploadStatus.innerHTML = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    uploadStatus.innerHTML = '<p class="text-danger small">{{ _("Upload failed. Please try again.") }}</p>';
                    imageUploadButton.disabled = false;
                });
            });
        }
    });
</script>
<div class="row">
    <main class="col-12 col-lg-8 position-relative main_pane">
        {% block title %}<h1>{{ _('Edit post') }}</h1>{% endblock %}
        <form method="post" enctype="multipart/form-data" role="form">
            {{ form.csrf_token() }}
            {% block post_type %}{% endblock %}
            {% if post_type == POST_TYPE_LINK %}
                {{ render_field(form.link_url) }}
                <div id="urlUsed"></div>
                <input type="hidden" id="retrieved_title" value="">
                <input type="hidden" id="retrieved_description" value="">
            {% endif -%}
            {{ render_field(form.title) }}
            {% if post_type == POST_TYPE_EVENT %}
                {{ render_field(form.start_datetime) }}
                {{ render_field(form.end_datetime) }}
                {{ render_field(form.event_timezone) }}
            {% endif %}
            {% if post_type == POST_TYPE_IMAGE or post_type == POST_TYPE_EVENT %}
                {% if post.image_id -%}
                    <div class="post_image">
                        {% if low_bandwidth -%}
                            <a href="{{ post.image.view_url(resize=True) }}" rel="nofollow ugc"><img src="{{ post.image.medium_url() }}"
                                alt="{{ post.image.alt_text if post.image.alt_text else post.title }}" fetchpriority="high" referrerpolicy="same-origin"
                                width="{{ post.image.width }}" height="{{ post.image.height }}" /></a>
                        {% else -%}
                            <a href="{{ post.image.view_url() }}" rel="nofollow ugc">
                                <img id="image_preview_edit" src="{{ post.image.view_url(resize=True) }}" lowsrc="{{ post.image.medium_url() }}"
                                    sizes="(max-width: 512px) 100vw, 854px" srcset="{{ post.image.medium_url() }} 512w, {{ post.image.view_url(resize=True) }} 1024w"
                                    alt="{{ post.image.alt_text if post.image.alt_text else post.title }}"
                                    fetchpriority="high" referrerpolicy="same-origin" >
                            </a>
                        {% endif -%}
                    </div>                
                {% endif %}
                {{ render_field(form.image_file) }}
                <img id="image_preview" style="" alt="Image preview">
                {% if post_type == POST_TYPE_IMAGE -%}
                    {{ render_field(form.image_alt_text) }}
                    <small class="field_hint">{{ _('Describe the image, to help visually impaired people.') }}</small>
                {% endif %}
            {% elif post_type == POST_TYPE_VIDEO %}
                {{ render_field(form.video_url) }}
                <p class="small field_hint">{{ _('Provide a URL ending with .mp4 or .webm.') }}</p>
            {% endif %}
            {{ render_field(form.body) }}

            {% if not low_bandwidth -%}
                <div class="row">
                    <div class="col-6">
                        <a href="#" hx-post="{{ url_for('post.preview') }}" hx-target="#preview">{{ _('Preview') }}</a> |
                        <a href="#" id="insertImage">{{ _('Insert image') }}</a>
                    </div>
                    <div class="col-6 text-right">
                        {% if markdown_editor %}
                            <script nonce="{{ nonce }}">
                                window.addEventListener("load", function () {
                                    var downarea = new DownArea({
                                        elem: document.querySelector('#body'),
                                        resize: DownArea.RESIZE_VERTICAL,
                                        hide: ['heading', 'bold-italic'],
                                        value: document.getElementById("body").value
                                    });
                                    setupAutoResize('body');
                                });
                            </script>
                        {% else %}
                            <a href="#" aria-hidden="true" class="markdown_editor_enabler create_post_markdown_editor_enabler" data-id="body">{{ _('Enable markdown editor') }}</a>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="preview"></div>
                    </div>
                </div>
            {% endif -%}

            {% if post_type == POST_TYPE_POLL %}
                <fieldset id="pollChoicesFieldset">
                    <legend>{{ _('Poll choices') }}</legend>
                    <div class="form-group">
                        {{ form.choice_1(class_="form-control", **{"placeholder": "First choice"}) }}
                    </div>
                    <div class="form-group">
                        {{ form.choice_2(class_="form-control", **{"placeholder": "Second choice"}) }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_3.data == none }}">
                        {{ form.choice_3(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_4.data == none }}">
                        {{ form.choice_4(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_5.data == none }}">
                        {{ form.choice_5(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_6.data == none }}">
                        {{ form.choice_6(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_7.data == none }}">
                        {{ form.choice_7(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_8.data == none }}">
                        {{ form.choice_8(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_9.data == none }}">
                        {{ form.choice_9(class_="form-control") }}
                    </div>
                    <div class="form-group" style="{{ 'display: none;' if form.choice_10.data == none }}">
                        {{ form.choice_10(class_="form-control") }}
                    </div>
                    <button id="addPollChoice" type="button" class="btn btn-primary">{{ _('Add choice') }}</button>
                </fieldset>
                {{ render_field(form.mode) }}
                {% if form.finish_in %}{{ render_field(form.finish_in) }}{% endif %}
                {{ render_field(form.local_only) }}
            {% endif %}

            {% if post_type == POST_TYPE_EVENT %}
                {{ render_field(form.max_attendees) }}
                {{ render_field(form.join_mode) }}
                {{ render_field(form.online) }}
                <div id="online_location" style="{% if event_online is false %}display: none;{% endif %}">
                    {{ render_field(form.online_link) }}
                </div>
                <div id="irl_location" style="{% if event_online %}display: none;{% endif %}">
                    {{ render_field(form.irl_address) }}
                    {{ render_field(form.irl_city) }}
                    {{ render_field(form.irl_country) }}
                </div>
            {% endif %}

            {{ render_field(form.tags) }}
            <small class="field_hint">{{ _('Separate each tag with a comma.') }}</small>

            <fieldset id="post_more_options" class="mt-4 mb-4 coolfieldset {{ 'collapsed' if request.cookies.get('fieldset_post_more_options_state', 'collapsed') == 'collapsed' }}">
                <legend class="w-auto">{{ _('More options') }}</legend>
                {{ render_field(form.notify_author) }}
                {{ render_field(form.sticky) }}
                {{ render_field(form.nsfw) }}
                {{ render_field(form.nsfl) }}
                {{ render_field(form.language_id) }}
                <div id="communityFlair">
                    {% if form.flair %}{{ render_field(form.flair) }}{% endif %}
                </div>
                {{ render_field(form.scheduled_for) }}
                {{ render_field(form.timezone) }}
                {{ render_field(form.repeat) }}

                <div class="accordion accordion-flush" id="accordionFlushExample">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
        {{ _('Hey, did you know? Scheduled posts have a templating system for titles.') }}
      </button>
    </h2>
    <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
      <div class="accordion-body">
            <p>{{ _('Tags available') }}:<code>{% raw %}{% week %}, {% day %}, {% month %}, {% year %}{% endraw %}</code></p>
            <p>{{ _('Example') }}: <code>{% raw %}[Topic week {% week %}] Today's date {% year %}-{% month %}-{% day %}{% endraw %}</code></p>
            <p>{{ _('...will generate') }}</p>
            <p>[Topic week 27] Today's date 2025-06-25</p>
        </div>
    </div>
  </div>
</div>
            </fieldset>

            {{ render_field(form.submit) }}
        </form>
        <p>&nbsp;</p>
        <hr>
        <p>{{ _('Drag this link to your bookmarks bar to create a quick way to share what you find') }}:</p>
        <p>
        <a href="javascript:(function(){
          var url = encodeURIComponent(window.location.href);
          var title = encodeURIComponent(document.title);
          window.open('https://{{ instance_domain }}/share?url=' + url + '&title=' + title, '_blank');
        })();"
           title="Drag this to your bookmarks bar"
           style="cursor: grab; text-decoration: underline;">{{ _('Share on PieFed') }}</a></p>
    <script src="/static/js/tomselect/tom-select.complete.min.js"></script>
    <script nonce="{{ nonce }}">
      document.addEventListener("DOMContentLoaded", () => {
        new TomSelect(".tom-select", {
          plugins: ['dropdown_input'],
          create: false,
          maxOptions: 2000,
       })
    });
    </script>
    </main>

    {% include "_side_pane.html" %}

</div>
<dialog id="insertImageDialog">
    <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">{{ _('Insert image') }}</h5>
            <button type="button" class="btn-close" aria-label="{{ _('Close') }}" id="insert_image_dialog_close"></button>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <input type="file" class="form-control" id="imageUploadInput" accept="image/*">
                <button class="btn btn-primary" type="button" id="imageUploadButton">{{ _('Upload') }}</button>
            </div>
            <div id="uploadStatus" class="mt-2"></div>
        </div>
        <hr>
        <div id="loadImagesHere"></div>
    </div>
</dialog>
{% endblock %}
